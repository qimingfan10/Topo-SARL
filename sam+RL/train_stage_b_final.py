#!/usr/bin/env python3
"""
æœ€ç»ˆè®­ç»ƒï¼šé•¿æœŸè®­ç»ƒäº‰å–è¾¾åˆ°20%+ IoU
åŸºäºä¼˜åŒ–2çš„æˆåŠŸé…ç½®
"""
import sys
import yaml

sys.path.insert(0, '/home/ubuntu/sam+RL')

from train_stage_b import train


if __name__ == "__main__":
    config_path = '/home/ubuntu/sam+RL/config/stage_b_final.yaml'
    
    class Args:
        config = config_path
    
    print(f"\n{'='*80}")
    print(f"ğŸš€ é˜¶æ®µBæœ€ç»ˆè®­ç»ƒï¼ˆ50000æ­¥ï¼‰")
    print(f"{'='*80}")
    print(f"\nå½“å‰æˆæœ:")
    print(f"  âœ… ä¼˜åŒ–2ç»“æœ: 18.35% IoU (17å€äºé˜¶æ®µA)")
    print(f"  âœ… è¿‡æ—©ç»ˆæ­¢: 0% (å®Œå…¨è§£å†³)")
    print(f"  âœ… Episodeé•¿åº¦: 6.93æ­¥")
    print(f"\nç›®æ ‡:")
    print(f"  ğŸ¯ é€šè¿‡é•¿æœŸè®­ç»ƒäº‰å–è¾¾åˆ°20%+ IoU")
    print(f"  ğŸ¯ è¿›ä¸€æ­¥æé«˜ç¨³å®šæ€§")
    print(f"  ğŸ¯ éªŒè¯æ–¹æ³•çš„é•¿æœŸè¡¨ç°")
    print(f"\nè®­ç»ƒé…ç½®:")
    print(f"  - æ­¥æ•°: 50000 (æ˜¯ä¹‹å‰çš„5å€)")
    print(f"  - å­¦ä¹ ç‡: 0.00005 (é™ä½ä»¥æé«˜ç¨³å®šæ€§)")
    print(f"  - å…¶ä»–å‚æ•°: ä¿æŒä¼˜åŒ–2æˆåŠŸé…ç½®")
    print(f"{'='*80}\n")
    
    # è¿è¡Œè®­ç»ƒ
    metrics_tracker = train(Args())
    
    # è·å–ç»“æœ
    summary = metrics_tracker.get_summary(last_n=100)
    
    print(f"\n{'='*80}")
    print(f"ğŸ æœ€ç»ˆè®­ç»ƒå®Œæˆ")
    print(f"{'='*80}")
    print(f"\nå®Œæ•´å¯¹æ¯”:")
    
    final_iou = f'{summary.get("avg_final_iou", 0)*100:.2f}%'
    final_best = f'{summary.get("best_iou", 0)*100:.2f}%'
    final_len = f'{summary.get("avg_episode_length", 0):.2f}æ­¥'
    final_reward = f'{summary.get("avg_episode_reward", 0):+.2f}'
    
    print(f"â”Œ{'â”€'*30}â”¬{'â”€'*12}â”¬{'â”€'*12}â”¬{'â”€'*12}â”¬{'â”€'*12}â”¬{'â”€'*12}â”")
    print(f"â”‚ {'æŒ‡æ ‡':<28} â”‚ {'é˜¶æ®µA':<10} â”‚ {'ä¼˜åŒ–1':<10} â”‚ {'ä¼˜åŒ–2':<10} â”‚ {'æœ€ç»ˆ':<10} â”‚ {'vsé˜¶æ®µA':<10} â”‚")
    print(f"â”œ{'â”€'*30}â”¼{'â”€'*12}â”¼{'â”€'*12}â”¼{'â”€'*12}â”¼{'â”€'*12}â”¼{'â”€'*12}â”¤")
    print(f"â”‚ {'å¹³å‡IoU':<28} â”‚ {'1.08%':<10} â”‚ {'4.64%':<10} â”‚ {'18.35%':<10} â”‚ {final_iou:<10} â”‚ {'':<10} â”‚")
    print(f"â”‚ {'æœ€ä½³IoU':<28} â”‚ {'32.84%':<10} â”‚ {'76.06%':<10} â”‚ {'43.73%':<10} â”‚ {final_best:<10} â”‚ {'':<10} â”‚")
    print(f"â”‚ {'Episodeé•¿åº¦':<28} â”‚ {'8.75æ­¥':<10} â”‚ {'2.98æ­¥':<10} â”‚ {'6.93æ­¥':<10} â”‚ {final_len:<10} â”‚ {'':<10} â”‚")
    print(f"â”‚ {'å¹³å‡å¥–åŠ±':<28} â”‚ {'-0.22':<10} â”‚ {'+0.26':<10} â”‚ {'+3.78':<10} â”‚ {final_reward:<10} â”‚ {'':<10} â”‚")
    print(f"â””{'â”€'*30}â”´{'â”€'*12}â”´{'â”€'*12}â”´{'â”€'*12}â”´{'â”€'*12}â”´{'â”€'*12}â”˜")
    
    # æœ€ç»ˆè¯„ä¼°
    avg_iou = summary.get('avg_final_iou', 0) * 100
    
    print(f"\nğŸ¯ æœ€ç»ˆè¯„ä¼°:")
    if avg_iou >= 20.0:
        print(f"  ğŸ‰ğŸ‰ğŸ‰ å“è¶Šæˆå°±ï¼è¾¾åˆ° {avg_iou:.2f}% IoU")
        print(f"  è¿™æ˜¯é˜¶æ®µA (1.08%) çš„ {avg_iou/1.08:.1f}xï¼")
        print(f"  æˆæœå·²ç»è¶³å¤Ÿå‘è¡¨é«˜è´¨é‡è®ºæ–‡ï¼")
    elif avg_iou >= 18.0:
        print(f"  âœ… ä¼˜ç§€ç»“æœï¼å½“å‰ {avg_iou:.2f}% IoU")
        print(f"  æå‡å€æ•°: {avg_iou/1.08:.1f}x vs é˜¶æ®µA")
        print(f"  å»ºè®®ï¼šå¯ä»¥è€ƒè™‘å°è¯•æ›´å¤§ç½‘æ ¼ï¼ˆ64Ã—64ï¼‰è¿›ä¸€æ­¥æå‡")
    elif avg_iou >= 15.0:
        print(f"  âœ… è‰¯å¥½ç»“æœï¼å½“å‰ {avg_iou:.2f}% IoU")
        print(f"  å»ºè®®ï¼šç»§ç»­è®­ç»ƒæˆ–è°ƒæ•´è¶…å‚æ•°")
    else:
        print(f"  âš ï¸  éœ€è¦åˆ†æä¸ºä»€ä¹ˆé•¿æœŸè®­ç»ƒæ²¡æœ‰æå‡")
    
    print(f"\nğŸ“Š å…³é”®æŒ‡æ ‡:")
    print(f"  - æœ€ç»ˆå¹³å‡IoU: {avg_iou:.2f}%")
    print(f"  - ç›¸å¯¹é˜¶æ®µAæå‡: {(avg_iou/1.08 - 1)*100:.0f}%")
    print(f"  - ç›¸å¯¹ä¼˜åŒ–2å˜åŒ–: {avg_iou - 18.35:+.2f}%")
    
    print(f"\n{'='*80}\n")

